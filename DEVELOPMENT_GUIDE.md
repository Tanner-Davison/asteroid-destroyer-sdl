# Asteroid Destroyer - Development Guide

For questions or collaboration reach out to Tanner Davison at tanner.davison95@gmail.com.

## Table of Contents

1. [Project Overview](#project-overview)
2. [Architecture Design](#architecture-design)
3. [Setup Instructions](#setup-instructions)
4. [Development Environment](#development-environment)
5. [Code Organization](#code-organization)
6. [Game Systems](#game-systems)
7. [Best Practices](#best-practices)
8. [Troubleshooting](#troubleshooting)

---

## Project Overview

Asteroid Destroyer is a 2D space shooter built with SDL3. Features include multi-player V-formation, physics-based movement, a bullet weapon system, level progression, and a live score display.

**Stack:** C++23 · SDL3 · SDL3_image · SDL3_ttf · CMake · vcpkg

---

## Architecture Design

### Core Design Principles

- **Separation of Concerns** — each class owns a single game component
- **Fixed Timestep** — physics runs at 120Hz independent of frame rate
- **RAII** — SDL resources are cleaned up in destructors, no manual free calls scattered around

### Class Hierarchy

```
Game
├── createwindow.cpp/hpp   — SDL3 init, window, renderer, global RNG
├── main.cpp               — game loop, collision orchestration
├── Player.cpp/hpp         — movement, input, texture, collision
│   └── weapon.cpp/hpp     — bullet pool, shoot cooldown
├── asteroid.cpp/hpp       — spawn, physics, wrap-around, texture
└── score.cpp/hpp          — score state, TTF rendering
```

### Data Flow

```
Input → Player → Physics → Collision → Render
  ↓        ↓        ↓          ↓          ↓
Keyboard → Velocity → Position → Hit Test → Screen
```

---

## Setup Instructions

### Prerequisites

| Tool               | Version       |
| ------------------ | ------------- |
| CMake              | 3.15+         |
| vcpkg              | latest        |
| GCC / Clang / MSVC | C++23 support |

### 1. Install vcpkg

```bash
git clone https://github.com/microsoft/vcpkg.git ~/vcpkg
cd ~/vcpkg
./bootstrap-vcpkg.sh   # macOS / Linux
.\bootstrap-vcpkg.bat  # Windows
```

Add to your shell profile (`~/.zshrc`, `~/.bashrc`, or PowerShell `$PROFILE`):

```bash
export VCPKG_ROOT=~/vcpkg
export CMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
```

### 2. Linux — install build dependencies

```bash
sudo apt install build-essential git cmake
```

### 3. macOS — install Xcode tools

```bash
xcode-select --install
```

### 4. Windows — install Visual Studio

[Visual Studio 2022](https://visualstudio.microsoft.com/) with the **Desktop development with C++** workload.

### Building

vcpkg installs SDL3, SDL3_image, and SDL3_ttf automatically on first configure.

#### macOS / Linux

```bash
mkdir build && cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
make -j$(sysctl -n hw.logicalcpu)   # macOS
make -j$(nproc)                     # Linux
```

#### Windows

```powershell
mkdir build && cd build
cmake .. -G "Visual Studio 17 2022" -A x64
cmake --build . --config Release
```

### Running

Always run from inside the build directory so the binary can find its assets:

```bash
cd build
./asteroid-destroyer        # macOS / Linux
.\asteroid-destroyer.exe    # Windows
```

### Project Structure

```
asteroid-destroyer/
├── src/
│   ├── main.cpp
│   ├── Player.cpp/hpp
│   ├── weapon.cpp/hpp
│   ├── asteroid.cpp/hpp
│   ├── score.cpp/hpp
│   ├── createwindow.cpp/hpp
│   ├── spaceship.png
│   └── asteroid.png
├── assets/
│   └── fonts/
│       └── FiraCode-Regular.ttf
├── CMakeLists.txt
├── vcpkg.json
├── .clangd
└── .clang-format
```

---

## Development Environment

### Neovim + clangd

clangd picks up include paths automatically from `compile_commands.json` generated by CMake. The `.clangd` file points to the build directory:

```yaml
CompileFlags:
  CompilationDatabase: build/

Index:
  Background: true

Diagnostics:
  ClangTidy:
    Add:
      - modernize-*
      - performance-*
    Remove:
      - modernize-use-trailing-return-type
      - readability-identifier-naming
```

Regenerate the compilation database after any CMake change:

```bash
cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
```

### SDL3 Include Paths

SDL3_image and SDL3_ttf use their own subdirectories when installed via vcpkg:

```cpp
#include <SDL3/SDL.h>
#include <SDL3_image/SDL_image.h>
#include <SDL3_ttf/SDL_ttf.h>
```

---

## Code Organization

### Include Order

```cpp
// SDL3
#include <SDL3/SDL.h>
#include <SDL3_image/SDL_image.h>
#include <SDL3_ttf/SDL_ttf.h>

// Standard library
#include <algorithm>
#include <memory>
#include <optional>
#include <vector>

// Project headers
#include "createwindow.hpp"
#include "Player.hpp"
```

### Resource Management

SDL resources use raw pointers with manual cleanup in destructors. Always null after destroying:

```cpp
bool Player::loadTexture(const char* path, SDL_Renderer* renderer) {
    if (mTexture) {
        SDL_DestroyTexture(mTexture);
        mTexture = nullptr;
    }
    SDL_Surface* surface = IMG_Load(path);
    if (!surface) return false;

    mTexture = SDL_CreateTextureFromSurface(renderer, surface);
    SDL_DestroySurface(surface);
    return mTexture != nullptr;
}
```

### SDL3 API Notes

Key differences from SDL2 that apply throughout this codebase:

- `SDL_Init` returns `bool` — check with `if (!SDL_Init(...))`
- `SDL_CreateRenderer` takes no index or flags — `SDL_CreateRenderer(window, nullptr)`
- `SDL_RenderCopy` → `SDL_RenderTexture`
- `SDL_FreeSurface` → `SDL_DestroySurface`
- `SDL_HasIntersection` → `SDL_GetRectIntersectionFloat`
- `SDL_Rect` → `SDL_FRect` for all rendering and collision
- `SDL_GetKeyboardState` returns `const bool*`
- `SDL_QUIT` → `SDL_EVENT_QUIT`

---

## Game Systems

### Fixed Timestep

Physics updates at a fixed 120Hz step regardless of rendering frame rate:

```cpp
const float FIXED_TIME_STEP = 1.0f / 120.0f;
float accumulator = 0.0f;
Uint64 lastTime = SDL_GetTicks();

while (!quit) {
    Uint64 currentTime = SDL_GetTicks();
    float deltaTime = (currentTime - lastTime) / 1000.0f;
    lastTime = currentTime;
    deltaTime = std::min(deltaTime, 0.25f);
    accumulator += deltaTime;

    while (accumulator >= FIXED_TIME_STEP) {
        updatePhysics();
        accumulator -= FIXED_TIME_STEP;
    }

    render();
}
```

### Collision Detection

All collision uses `SDL_GetRectIntersectionFloat` with `SDL_FRect`:

```cpp
SDL_FRect result;
if (SDL_GetRectIntersectionFloat(&rectA, &rectB, &result)) {
    // collision occurred
}
```

### V-Formation Spawn

Players spawn in a symmetric V pattern around screen center:

```cpp
int middleIndex = count / 2;
for (int i = 0; i < count; ++i) {
    int offsetX = (i - middleIndex) * PLAYER_SPACING;
    int offsetY = std::abs(i - middleIndex) * VERTICAL_OFFSET;
    players.emplace_back(std::make_unique<Player>(centerX + offsetX, bottomY - offsetY));
}
```

### Weapon System

Bullets are pooled in a `std::vector` and erased when off-screen or deactivated:

```cpp
void Weapon::shoot() {
    if (!canShoot()) return;
    float velX = bulletSpeed * cos(angle);
    float velY = bulletSpeed * sin(angle);
    bullets.emplace_back(x, y, velX, velY);
    lastShotTime = SDL_GetTicks();
}

bool Weapon::canShoot() {
    return (SDL_GetTicks() - lastShotTime >= static_cast<Uint64>(cooldown));
}
```

---

## Best Practices

**Always free surfaces immediately** after creating a texture from them — surfaces are CPU memory and textures are GPU memory, holding both wastes resources.

**Use `SDL_FRect` throughout** — SDL3 moved rendering to float coordinates. Mixing `SDL_Rect` and `SDL_FRect` will cause compile errors or silent precision loss.

**Pre-allocate vectors** when the count is known ahead of time to avoid reallocations during the game loop.

**Never call `SDL_GetError` for SDL3_ttf or SDL3_image errors** — those libraries set their own error strings accessible via `SDL_GetError()` in SDL3, but double check the function return value first.

---

## Troubleshooting

**`Unsupported image format` on PNG load**
Make sure `vcpkg.json` requests the `png` feature for sdl3-image:

```json
{ "name": "sdl3-image", "features": ["png"] }
```

Then delete the build directory and reconfigure from scratch.

**`file not found` for font or images at runtime**
Run the binary from inside the build directory. CMake copies assets there at build time.

**clangd showing incorrect errors / missing includes**
Regenerate `compile_commands.json`:

```bash
cd build
cmake .. -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake
```

Then restart your LSP.

**Duplicate library warning on macOS**

```
ld: warning: ignoring duplicate libraries: 'libSDL3.a'
```

This is harmless — vcpkg links SDL3 twice through different targets. The binary is fine.

**Windows — missing DLLs at runtime**
vcpkg handles DLL copying automatically when using the CMake toolchain. If DLLs are missing, ensure `CMAKE_TOOLCHAIN_FILE` is set and reconfigure.
